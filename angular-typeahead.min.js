angular.module("siyfion.sfTypeahead",[]).directive("sfTypeahead",function(){return{restrict:"AC",require:"?ngModel",scope:{options:"=",datasets:"=",suggestionKey:"@"},link:function(h,c,f,b){var j=h.options||{},a=(angular.isArray(h.datasets)?h.datasets:[h.datasets])||[],g=true;d();h.$watch("options",d);if(angular.isArray(h.datasets)){h.$watchCollection("datasets",d)}else{h.$watch("datasets",d)}b.$parsers.push(function(k){if(k===c.typeahead("val")){return b.$modelValue}var l=angular.isObject(k);if(j.editable===false){b.$setValidity("typeahead",l);return l?k:undefined}return k});b.$formatters.push(function(k){if(angular.isObject(k)){var l=false;$.each(a,function(n,r){var q=r.source,m=r.displayKey||"value",p=(angular.isFunction(m)?m(k):k[m])||"";if(l){return false}if(!p){o([]);return}q(p,o);return;function o(s){var t=i(s,k);if(t){b.$setViewValue(k);l=true}else{b.$setViewValue(j.editable===false?undefined:k)}if(l||n===a.length-1){setTimeout(function(){h.$apply(function(){c.typeahead("val",p)})},0)}}});return""}else{if(k==null){c.typeahead("val",null)}}return k});function d(){if(g){c.typeahead(h.options,h.datasets);g=false}else{var k=c.val();c.typeahead("destroy");c.typeahead(h.options,h.datasets);c.triggerHandler("typeahead:opened")}}function i(m,k){var l=-1;angular.forEach(m,function(o,n){if(angular.equals(k,o)){l=n}});return l>=0}function e(l,k,m){h.$apply(function(){var n=(angular.isDefined(h.suggestionKey))?k[h.suggestionKey]:k;b.$setViewValue(n)})}c.bind("typeahead:selected",function(l,k,m){e(l,k,m);h.$emit("typeahead:selected",k,m)});c.bind("typeahead:autocompleted",function(l,k,m){e(l,k,m);h.$emit("typeahead:autocompleted",k,m)});c.bind("typeahead:opened",function(){h.$emit("typeahead:opened")});c.bind("typeahead:closed",function(){h.$emit("typeahead:closed")});c.bind("typeahead:asyncrequest",function(){h.$emit("typeahead:asyncrequest")});c.bind("typeahead:asynccancel",function(){h.$emit("typeahead:asynccancel")});c.bind("typeahead:asyncreceive",function(){h.$emit("typeahead:asyncreceive")});c.bind("typeahead:cursorchanged",function(l,k,m){h.$emit("typeahead:cursorchanged",l,k,m)})}}});